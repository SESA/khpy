#!/usr/bin/env python

########################################
#  Kittyhawk Command-line Interface    #
########################################
import argparse
import ConfigParser 
import os
import sys

# load envoirnment variables
khsrc = os.path.dirname(os.path.abspath(__file__))
sys.path.append(khsrc)
required_vars = ["KHDB", "KHTYPE"] #TODO: move into config
missing_vars = False
for i in required_vars:
  if os.getenv(i) == None:
    print "Error: missing environment variable",i
    missing_vars = True
if missing_vars:
  exit()
# verify location of database
if os.path.exists(os.getenv("KHDB")) == 0:
  print "Error: invalid $KHDB directory", os.getenv("KHDB")
  exit()

# import configuration
Config = ConfigParser.SafeConfigParser()
Config.read(os.path.join(khsrc,"kh.cfg"))

# Construct an KH object specified in the configuration
def load_kh_type():
  env = os.getenv("KHTYPE")
  configs=[os.path.join(khsrc,"kh_base.cfg")]
  for i in Config.sections():
    if env == i:
      # load modules from src dir
      cls = Config.get(i, 'class')
      mod = __import__(i, fromlist=[cls])
      ref = getattr(mod, cls)
      # build configuration list
      configs.append(os.path.join(khsrc,Config.get(i,'config')))
      # this constructs and returns kh object
      return ref(configs)
  # return base object if no platform was loaded
  print "Warning: platform type not specified"
  from kh_base import KhBase
  return KhBase(configs)
  
# create the command-line argument parser
par    = argparse.ArgumentParser()
subpar = par.add_subparsers()

# configure parsers for KH commands
kh = load_kh_type()
clean_parser = kh.parse_clean(subpar.add_parser('clean',
  formatter_class=argparse.ArgumentDefaultsHelpFormatter,
  description="Close all active jobs, empty free pool"))
get_parser   = kh.parse_get(subpar.add_parser('get', 
  formatter_class=argparse.ArgumentDefaultsHelpFormatter,
  description="Allocate new instances for the given job."))
info_parser  = kh.parse_info(subpar.add_parser('info',
  formatter_class=argparse.ArgumentDefaultsHelpFormatter,
  description="List active jobs"))
init_parser = kh.parse_init(subpar.add_parser('init',
  formatter_class=argparse.ArgumentDefaultsHelpFormatter,
  description="Initialize free pool from default settings"))
inst_parser  = kh.parse_install(subpar.add_parser('install',
  formatter_class=argparse.ArgumentDefaultsHelpFormatter,
  description="Create empty database structure (free pool empty)"))
rm_parser    = kh.parse_rm(subpar.add_parser('rm',
  formatter_class=argparse.ArgumentDefaultsHelpFormatter,
  description="Remove job, free assigned nodes"))

# parse and run command
clinput = vars(par.parse_args())

# attach optional dictionary at the end of arg list
if 'optional_args' in clinput:
  clinput['required_args'].append('optional_args')

# TODO: find a better way to pass variable arguments count
if 'required_args' not in clinput:
  clinput['func']()
elif len(clinput['required_args']) == 1:
  clinput['func']( clinput[clinput['required_args'][0]] )
elif len(clinput['required_args']) == 2:
  clinput['func']( clinput[clinput['required_args'][0]], 
      clinput[clinput['required_args'][1]] )
elif len(clinput['required_args']) == 3:
  clinput['func']( clinput[clinput['required_args'][0]], 
      clinput[clinput['required_args'][1]],
      clinput[clinput['required_args'][2]] )
elif len(clinput['required_args']) == 4:
  clinput['func']( clinput[clinput['required_args'][0]], 
      clinput[clinput['required_args'][1]],
      clinput[clinput['required_args'][2]],
      clinput[clinput['required_args'][3]] )
elif len(clinput['required_args']) == 5:
  clinput['func']( clinput[clinput['required_args'][0]], 
      clinput[clinput['required_args'][1]],
      clinput[clinput['required_args'][2]],
      clinput[clinput['required_args'][3]],
      clinput[clinput['required_args'][4]] )
elif len(clinput['required_args']) == 6:
  clinput['func']( clinput[clinput['required_args'][0]], 
      clinput[clinput['required_args'][1]],
      clinput[clinput['required_args'][2]],
      clinput[clinput['required_args'][3]],
      clinput[clinput['required_args'][4]],
      clinput[clinput['required_args'][5]] )

# print "I'm finished."
